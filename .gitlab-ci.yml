# .gitlab-ci.yml - See https://docs.gitlab.com/ee/ci/yaml

variables:
  GIT_DEPTH: "3"
  GIT_SUBMODULE_STRATEGY: "recursive"

stages:
  - build
  - lint
  - test
  - deploy

.hugo:
  # Hugo container images in GitLab Container Registry: https://gitlab.com/pages/hugo/container_registry
  # image: registry.gitlab.com/pages/hugo:latest
  # Hugo container image including Node.js for the webpacker asset pipeline
  image:
    name: klakegg/hugo:ext-alpine
    entrypoint: [""]
  cache:
    paths:
      - node_modules
      - public
      - resources

build:
  extends: .hugo
  stage: build
  script:
    - npm install

hugo:
  extends: .hugo
  stage: test
  script:
    - hugo
  except:
    - main
    - master

pages:
  extends: .hugo
  stage: deploy
  script:
    - hugo
  artifacts:
    paths:
      - public
  only:
    - main
    - master

eslint:
  stage: lint
  image: pipelinecomponents/eslint:latest
  before_script:
    - touch dummy.js
  script:
    - eslint $( [[ -e .eslintrc ]] || echo '--no-eslintrc' ) --color .

markdownlint:
  stage: lint
  image:
    name: thegeeklab/markdownlint-cli:latest
    entrypoint: ["/bin/ash", "-c"]
  script:
    - markdownlint-cli .

stylelint:
  stage: lint
  image: pipelinecomponents/stylelint:latest
  script:
    - stylelint --color '**/*.css'
  rules:
    - allow_failure: true

yamllint:
  stage: lint
  image:
    name: cytopia/yamllint:latest
    entrypoint: ["/bin/ash", "-c"]
  script:
    - yamllint -f colored .
